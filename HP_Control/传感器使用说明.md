# ä¼ æ„Ÿå™¨ä½¿ç”¨è¯´æ˜

## ğŸ“‹ æ¦‚è¿°
æœ¬ç³»ç»Ÿæ”¯æŒå››è·¯ä¼ æ„Ÿå™¨ADCé‡‡é›†ï¼Œå®ç°å¯¹æ²¹æ¸©ã€é«˜å‹ç½æ¸©åº¦ã€æ²¹å‹ã€é«˜å‹ç½å‹åŠ›çš„å®æ—¶ç›‘æ§ã€‚ç³»ç»Ÿé‡‡ç”¨12ä½ADCï¼Œæ”¯æŒPT1000æ¸©åº¦ä¼ æ„Ÿå™¨å’Œ4-20mAå‹åŠ›ä¼ æ„Ÿå™¨ã€‚

## ğŸ”§ ç¡¬ä»¶æ¥å£

| é€šé“ | ä¼ æ„Ÿå™¨ç±»å‹ | MCUå¼•è„š | ç‰©ç†å¼•è„š | æµ‹é‡èŒƒå›´ | ç²¾åº¦ |
|------|------------|---------|----------|----------|------|
| 0 | LNGæ¸©åº¦ | PA2_ADC1_IN0_T | 48 | PT1000, -40â„ƒ~90â„ƒ | Â±1â„ƒ |
| 1 | æ²¹æ¸© | PA3_ADC1_IN1_LNG_T | 47 | PT1000, -40â„ƒ~90â„ƒ | Â±1â„ƒ |
| 2 | æ²¹å‹ | PD2_ADC1_IN2_P | 46 | 4-20mA, 0-40MPa | Â±0.1MPa |
| 3 | LNGå‹åŠ› | PD3_ADC1_IN3_LNG_P | 45 | 4-20mA, 0-35MPa | Â±0.1MPa |

## ğŸ“¡ æ ¸å¿ƒæ¥å£

### åˆå§‹åŒ–
```c
void Sensor_Init(void);           // ä¼ æ„Ÿå™¨æ¨¡å—åˆå§‹åŒ–
void Sensor_InitADC(void);        // ADCç¡¬ä»¶åˆå§‹åŒ–
void Sensor_InitMonitor(void);    // ä¼ æ„Ÿå™¨ç›‘æ§åˆå§‹åŒ–
```

### æ•°æ®è·å–
```c
uint16_t Sensor_GetADCValue(uint8_t channel);                    // è·å–æŒ‡å®šé€šé“ADCå€¼
void Sensor_GetAllADCValues(uint16_t raw_values[ADC_CHANNEL_COUNT]); // è·å–æ‰€æœ‰ADCå€¼
```

### æ•°æ®è½¬æ¢
```c
float Sensor_ConvertAdcToVoltage(uint16_t adc_raw);              // ADCè½¬ç”µå‹
float Sensor_ADCToOilTemperature(uint16_t adc_raw);              // ADCè½¬æ²¹æ¸©
float Sensor_ADCToLNGTemperature(uint16_t adc_raw);              // ADCè½¬LNGæ¸©åº¦
float Sensor_ADCToOilPressure(uint16_t adc_raw);                 // ADCè½¬æ²¹å‹
float Sensor_ADCToLNGPressure(uint16_t adc_raw);                 // ADCè½¬LNGå‹åŠ›
```

### ç‰©ç†é‡è·å–
```c
float Sensor_GetOilTemperature(void);                            // è·å–æ²¹æ¸©
float Sensor_GetLNGTemperature(void);                            // è·å–LNGæ¸©åº¦
float Sensor_GetOilPressure(void);                               // è·å–æ²¹å‹
float Sensor_GetLNGPressure(void);                               // è·å–LNGå‹åŠ›
```

### ç›‘æ§å’Œè¯Šæ–­
```c
void Sensor_UpdateMonitor(void);                                 // æ›´æ–°ä¼ æ„Ÿå™¨ç›‘æ§
const sensor_data_t* Sensor_GetMonitorData(void);                // è·å–ç›‘æ§æ•°æ®
bool Sensor_CheckDataValidity(void);                             // æ£€æŸ¥æ•°æ®æœ‰æ•ˆæ€§
sensor_fault_status_t Sensor_GetFaultStatus(void);               // è·å–æ•…éšœçŠ¶æ€
```

## ğŸ’» ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ä½¿ç”¨
```c
#include "sensor.h"

int main(void)
{
    Sensor_Init();                    // åˆå§‹åŒ–ä¼ æ„Ÿå™¨æ¨¡å—
    
    while(1)
    {
        Sensor_UpdateMonitor();       // æ›´æ–°ä¼ æ„Ÿå™¨æ•°æ®
        
        float oil_temp = Sensor_GetOilTemperature();
        float lng_pressure = Sensor_GetLNGPressure();
        
        OSIF_TimeDelay(100);
    }
}
```

### æµ‹è¯•æ¨¡å¼
```c
#include "test_functions.h"

Test_SetMode(TEST_MODE_SENSORS);     // è®¾ç½®ä¼ æ„Ÿå™¨æµ‹è¯•æ¨¡å¼
Test_ExecuteCurrentMode();           // æ‰§è¡Œæµ‹è¯•
```

## âš™ï¸ æŠ€æœ¯å‚æ•°

- **ADCåˆ†è¾¨ç‡**: 12ä½ï¼ˆ0-4095ï¼‰
- **å‚è€ƒç”µå‹**: 5V
- **é‡‡æ ·é¢‘ç‡**: 200Hzï¼ˆ5mså‘¨æœŸï¼‰
- **æ»¤æ³¢ç®—æ³•**: ç§»åŠ¨å¹³å‡æ»¤æ³¢
- **æ»¤æ³¢çª—å£**: 5ä¸ªé‡‡æ ·ç‚¹
- **æ¸©åº¦æ ¡å‡†**: æ”¯æŒPT1000æ¸©åº¦åç§»æ ¡å‡†

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **åˆå§‹åŒ–é¡ºåº**: å¿…é¡»å…ˆè°ƒç”¨`Sensor_Init()`
2. **é‡‡æ ·é¢‘ç‡**: ç³»ç»Ÿè‡ªåŠ¨5mså‘¨æœŸé‡‡é›†ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒç”¨
3. **ç¡¬ä»¶è¿æ¥**: ç¡®ä¿ä¼ æ„Ÿå™¨è¾“å‡ºåœ¨0-5VèŒƒå›´å†…
4. **ç”µæºç¨³å®š**: ç¡®ä¿ä¼ æ„Ÿå™¨ä¾›ç”µç¨³å®š
5. **æ¸©åº¦æ ¡å‡†**: å¯é€šè¿‡`g_oil_temp_calibration_offset`å’Œ`g_lng_temp_calibration_offset`è°ƒæ•´

## ğŸ” æ•…éšœè¯Šæ–­

### å¸¸è§æ•…éšœ
- **ä¼ æ„Ÿå™¨æ— ä¿¡å·**: æ£€æŸ¥ç¡¬ä»¶è¿æ¥å’Œç”µæº
- **æ•°æ®å¼‚å¸¸**: æ£€æŸ¥ä¼ æ„Ÿå™¨æ ¡å‡†å‚æ•°
- **é€šä¿¡ä¸­æ–­**: æ£€æŸ¥ADCé…ç½®å’Œæ—¶é’Ÿ

### æ•…éšœå¤„ç†
```c
sensor_fault_status_t fault = Sensor_GetFaultStatus();
if (fault != SENSOR_FAULT_NONE) {
    printf("Sensor fault detected: %d\r\n", fault);
}
```

### æ•…éšœçŠ¶æ€æšä¸¾
```c
typedef enum {
    SENSOR_FAULT_NONE = 0x00,           // æ— æ•…éšœ
    SENSOR_FAULT_OIL_TEMP = 0x01,       // æ²¹æ¸©ä¼ æ„Ÿå™¨æ•…éšœ
    SENSOR_FAULT_LNG_TEMP = 0x02,       // LNGæ¸©åº¦ä¼ æ„Ÿå™¨æ•…éšœ
    SENSOR_FAULT_OIL_PRESSURE = 0x04,   // æ²¹å‹ä¼ æ„Ÿå™¨æ•…éšœ
    SENSOR_FAULT_LNG_PRESSURE = 0x08,   // LNGå‹åŠ›ä¼ æ„Ÿå™¨æ•…éšœ
    SENSOR_FAULT_ADC = 0x10,            // ADCæ•…éšœ
    SENSOR_FAULT_TIMEOUT = 0x20         // ä¼ æ„Ÿå™¨è¶…æ—¶æ•…éšœ
} sensor_fault_status_t;
```

## ğŸ”§ é«˜çº§åŠŸèƒ½

### æ•°æ®æ»¤æ³¢
- **ç§»åŠ¨å¹³å‡æ»¤æ³¢**: 5ç‚¹ç§»åŠ¨å¹³å‡ï¼Œå‡å°‘å™ªå£°å½±å“
- **è¶‹åŠ¿åˆ†æ**: æ”¯æŒå‹åŠ›å˜åŒ–è¶‹åŠ¿æ£€æµ‹
- **å¼‚å¸¸æ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹ä¼ æ„Ÿå™¨æ•°æ®å¼‚å¸¸

### ç›‘æ§é›†æˆ
- **ç³»ç»Ÿç›‘æ§**: ä¸ç›‘æ§æ¨¡å—é›†æˆï¼Œæä¾›ç³»ç»Ÿå¥åº·çŠ¶æ€
- **æ•…éšœè¯Šæ–­**: æ”¯æŒä¼ æ„Ÿå™¨æ•…éšœè‡ªåŠ¨è¯Šæ–­å’ŒæŠ¥å‘Š
- **æ•°æ®è®°å½•**: æ”¯æŒä¼ æ„Ÿå™¨æ•°æ®å†å²è®°å½•

## ğŸ“Š ä»»åŠ¡è°ƒåº¦é›†æˆ

### è‡ªåŠ¨æ•°æ®é‡‡é›†
ä¼ æ„Ÿå™¨æ¨¡å—å·²é›†æˆåˆ°ä»»åŠ¡è°ƒåº¦å™¨ä¸­ï¼š

```c
// åœ¨5msä»»åŠ¡ä¸­è‡ªåŠ¨æ‰§è¡Œä¼ æ„Ÿå™¨æ•°æ®é‡‡é›†
void Task1_5ms(void)
{
    // ä¼ æ„Ÿå™¨æ•°æ®é‡‡é›†å’Œæ›´æ–°
    HydraulicControl_UpdateSensors();
}
```

### ç›‘æ§æ›´æ–°
```c
// åœ¨100msä»»åŠ¡ä¸­æ›´æ–°ä¼ æ„Ÿå™¨ç›‘æ§çŠ¶æ€
void Task4_100ms(void)
{
    // æ›´æ–°ä¼ æ„Ÿå™¨ç›‘æ§
    Monitor_UpdateAll();
}
```

## ğŸ”§ ç³»ç»Ÿé›†æˆ

### å¯åŠ¨æµç¨‹é›†æˆ
```c
// åœ¨main.cçš„SystemInit()å‡½æ•°ä¸­
static void SystemInit(void)
{
    // ... å…¶ä»–åˆå§‹åŒ– ...
    
    // ä¼ æ„Ÿå™¨æ¨¡å—åˆå§‹åŒ–
    Sensor_Init();
    
    // ... å…¶ä»–æ¨¡å—åˆå§‹åŒ– ...
}
```

### æ¶²å‹æ§åˆ¶é›†æˆ
```c
// åœ¨æ¶²å‹æ§åˆ¶æ¨¡å—ä¸­ä½¿ç”¨ä¼ æ„Ÿå™¨æ•°æ®
float current_oil_pressure = Sensor_GetOilPressure();
float current_lng_pressure = Sensor_GetLNGPressure();
float current_oil_temp = Sensor_GetOilTemperature();
```

### CANé€šä¿¡é›†æˆ
```c
// åœ¨CANé€šä¿¡æ¨¡å—ä¸­è·å–ä¼ æ„Ÿå™¨æ•°æ®
status.oil_pressure = Sensor_GetOilPressure();
status.gas_pressure = Sensor_GetLNGPressure();
status.oil_temperature = Sensor_GetOilTemperature();
status.gas_temperature = Sensor_GetLNGTemperature();
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 6.0  
**æ›´æ–°æ—¥æœŸ**: 2024å¹´  
**é€‚ç”¨ä»£ç **: sensor.c + pt1000_temp_calibration.c  
**æœ€åæ›´æ–°**: æ ¹æ®æœ€æ–°ä»£ç å®ç°æ›´æ–°æ¥å£è¯´æ˜å’ŒæŠ€æœ¯å‚æ•°ï¼Œå¢åŠ æ•…éšœè¯Šæ–­ã€é«˜çº§åŠŸèƒ½ã€ä»»åŠ¡è°ƒåº¦é›†æˆå’Œç³»ç»Ÿé›†æˆè¯´æ˜ 