# 传感器使用说明

## 📋 概述
本系统支持四路传感器ADC采集，实现对油温、高压罐温度、油压、高压罐压力的实时监控。系统采用12位ADC，支持PT1000温度传感器和4-20mA压力传感器。

## 🔧 硬件接口

| 通道 | 传感器类型 | MCU引脚 | 物理引脚 | 测量范围 | 精度 |
|------|------------|---------|----------|----------|------|
| 0 | LNG温度 | PA2_ADC1_IN0_T | 48 | PT1000, -40℃~90℃ | ±1℃ |
| 1 | 油温 | PA3_ADC1_IN1_LNG_T | 47 | PT1000, -40℃~90℃ | ±1℃ |
| 2 | 油压 | PD2_ADC1_IN2_P | 46 | 4-20mA, 0-40MPa | ±0.1MPa |
| 3 | LNG压力 | PD3_ADC1_IN3_LNG_P | 45 | 4-20mA, 0-35MPa | ±0.1MPa |

## 📡 核心接口

### 初始化
```c
void Sensor_Init(void);           // 传感器模块初始化
void Sensor_InitADC(void);        // ADC硬件初始化
void Sensor_InitMonitor(void);    // 传感器监控初始化
```

### 数据获取
```c
uint16_t Sensor_GetADCValue(uint8_t channel);                    // 获取指定通道ADC值
void Sensor_GetAllADCValues(uint16_t raw_values[ADC_CHANNEL_COUNT]); // 获取所有ADC值
```

### 数据转换
```c
float Sensor_ConvertAdcToVoltage(uint16_t adc_raw);              // ADC转电压
float Sensor_ADCToOilTemperature(uint16_t adc_raw);              // ADC转油温
float Sensor_ADCToLNGTemperature(uint16_t adc_raw);              // ADC转LNG温度
float Sensor_ADCToOilPressure(uint16_t adc_raw);                 // ADC转油压
float Sensor_ADCToLNGPressure(uint16_t adc_raw);                 // ADC转LNG压力
```

### 物理量获取
```c
float Sensor_GetOilTemperature(void);                            // 获取油温
float Sensor_GetLNGTemperature(void);                            // 获取LNG温度
float Sensor_GetOilPressure(void);                               // 获取油压
float Sensor_GetLNGPressure(void);                               // 获取LNG压力
```

### 监控和诊断
```c
void Sensor_UpdateMonitor(void);                                 // 更新传感器监控
const sensor_data_t* Sensor_GetMonitorData(void);                // 获取监控数据
bool Sensor_CheckDataValidity(void);                             // 检查数据有效性
sensor_fault_status_t Sensor_GetFaultStatus(void);               // 获取故障状态
```

## 💻 使用示例

### 基础使用
```c
#include "sensor.h"

int main(void)
{
    Sensor_Init();                    // 初始化传感器模块
    
    while(1)
    {
        Sensor_UpdateMonitor();       // 更新传感器数据
        
        float oil_temp = Sensor_GetOilTemperature();
        float lng_pressure = Sensor_GetLNGPressure();
        
        OSIF_TimeDelay(100);
    }
}
```

### 测试模式
```c
#include "test_functions.h"

Test_SetMode(TEST_MODE_SENSORS);     // 设置传感器测试模式
Test_ExecuteCurrentMode();           // 执行测试
```

## ⚙️ 技术参数

- **ADC分辨率**: 12位（0-4095）
- **参考电压**: 5V
- **采样频率**: 200Hz（5ms周期）
- **滤波算法**: 移动平均滤波
- **滤波窗口**: 5个采样点
- **温度校准**: 支持PT1000温度偏移校准

## ⚠️ 注意事项

1. **初始化顺序**: 必须先调用`Sensor_Init()`
2. **采样频率**: 系统自动5ms周期采集，无需手动调用
3. **硬件连接**: 确保传感器输出在0-5V范围内
4. **电源稳定**: 确保传感器供电稳定
5. **温度校准**: 可通过`g_oil_temp_calibration_offset`和`g_lng_temp_calibration_offset`调整

## 🔍 故障诊断

### 常见故障
- **传感器无信号**: 检查硬件连接和电源
- **数据异常**: 检查传感器校准参数
- **通信中断**: 检查ADC配置和时钟

### 故障处理
```c
sensor_fault_status_t fault = Sensor_GetFaultStatus();
if (fault != SENSOR_FAULT_NONE) {
    printf("Sensor fault detected: %d\r\n", fault);
}
```

### 故障状态枚举
```c
typedef enum {
    SENSOR_FAULT_NONE = 0x00,           // 无故障
    SENSOR_FAULT_OIL_TEMP = 0x01,       // 油温传感器故障
    SENSOR_FAULT_LNG_TEMP = 0x02,       // LNG温度传感器故障
    SENSOR_FAULT_OIL_PRESSURE = 0x04,   // 油压传感器故障
    SENSOR_FAULT_LNG_PRESSURE = 0x08,   // LNG压力传感器故障
    SENSOR_FAULT_ADC = 0x10,            // ADC故障
    SENSOR_FAULT_TIMEOUT = 0x20         // 传感器超时故障
} sensor_fault_status_t;
```

## 🔧 高级功能

### 数据滤波
- **移动平均滤波**: 5点移动平均，减少噪声影响
- **趋势分析**: 支持压力变化趋势检测
- **异常检测**: 自动检测传感器数据异常

### 监控集成
- **系统监控**: 与监控模块集成，提供系统健康状态
- **故障诊断**: 支持传感器故障自动诊断和报告
- **数据记录**: 支持传感器数据历史记录

## 📊 任务调度集成

### 自动数据采集
传感器模块已集成到任务调度器中：

```c
// 在5ms任务中自动执行传感器数据采集
void Task1_5ms(void)
{
    // 传感器数据采集和更新
    HydraulicControl_UpdateSensors();
}
```

### 监控更新
```c
// 在100ms任务中更新传感器监控状态
void Task4_100ms(void)
{
    // 更新传感器监控
    Monitor_UpdateAll();
}
```

## 🔧 系统集成

### 启动流程集成
```c
// 在main.c的SystemInit()函数中
static void SystemInit(void)
{
    // ... 其他初始化 ...
    
    // 传感器模块初始化
    Sensor_Init();
    
    // ... 其他模块初始化 ...
}
```

### 液压控制集成
```c
// 在液压控制模块中使用传感器数据
float current_oil_pressure = Sensor_GetOilPressure();
float current_lng_pressure = Sensor_GetLNGPressure();
float current_oil_temp = Sensor_GetOilTemperature();
```

### CAN通信集成
```c
// 在CAN通信模块中获取传感器数据
status.oil_pressure = Sensor_GetOilPressure();
status.gas_pressure = Sensor_GetLNGPressure();
status.oil_temperature = Sensor_GetOilTemperature();
status.gas_temperature = Sensor_GetLNGTemperature();
```

---

**文档版本**: 6.0  
**更新日期**: 2024年  
**适用代码**: sensor.c + pt1000_temp_calibration.c  
**最后更新**: 根据最新代码实现更新接口说明和技术参数，增加故障诊断、高级功能、任务调度集成和系统集成说明 